<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Math OCR - Expression Recognition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/cropperjs/dist/cropper.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/cropperjs/dist/cropper.min.css">
</head>
<body class="bg-gray-100 min-h-screen flex flex-col">
    <header class="bg-blue-600 text-white py-6 shadow-md">
        <div class="container mx-auto px-4 text-center">
            <h1 class="text-3xl font-bold">Math Expression OCR</h1>
            <p class="mt-2 text-blue-100">Recognize and Solve Mathematical Expressions</p>
        </div>
    </header>

    <main class="container mx-auto px-4 py-8 flex-grow">
        <div class="bg-white shadow-lg rounded-lg p-6">
            <div class="grid md:grid-cols-2 gap-6">
                <div class="space-y-4">
                    <div class="border-2 border-dashed border-gray-300 rounded-lg p-4">
                        <input 
                            type="file" 
                            id="imageUpload" 
                            accept="image/*" 
                            class="hidden"
                        >
                        <label 
                            for="imageUpload" 
                            class="block w-full text-center py-2 px-4 bg-blue-500 text-white rounded-md cursor-pointer hover:bg-blue-600 transition"
                        >
                            Upload Image
                        </label>
                    </div>

                    <div id="imageContainer" class="relative" style="display: none;">
                        <img 
                            id="uploadedImage" 
                            src="#" 
                            alt="Uploaded Image" 
                            class="max-w-full rounded-lg"
                        >
                        <div class="flex space-x-2 mt-2">
                            <button 
                                id="cropToggle" 
                                class="w-1/2 py-2 px-4 bg-green-500 text-white rounded-md hover:bg-green-600 transition hidden"
                            >
                                Select Crop Area
                            </button>
                            <button 
                                id="processImage" 
                                class="w-1/2 py-2 px-4 bg-purple-500 text-white rounded-md hover:bg-purple-600 transition hidden"
                            >
                                Process Image
                            </button>
                        </div>
                    </div>
                </div>

                <div class="space-y-4">
                    <div class="bg-gray-50 rounded-lg p-4">
                        <h2 class="text-xl font-semibold mb-4 text-gray-800">Results</h2>
                        <div id="loadingSpinner" class="hidden flex justify-center items-center">
                            <div class="animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-purple-500"></div>
                        </div>
                        <div id="resultContainer" class="space-y-2">
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Expression</label>
                                <input 
                                    type="text" 
                                    id="expressionResult" 
                                    class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200" 
                                    readonly
                                >
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Solution</label>
                                <input 
                                    type="text" 
                                    id="solutionResult" 
                                    class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200" 
                                    readonly
                                >
                            </div>
                            <div id="errorMessage" class="text-red-500 mt-2 hidden"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <footer class="bg-gray-800 text-white py-4">
        <div class="container mx-auto px-4 text-center">
            <p>&copy; 2024 Math OCR. Powered by HuggingFace</p>
        </div>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // DOM Element References
            const imageUpload = document.getElementById('imageUpload');
            const uploadedImage = document.getElementById('uploadedImage');
            const imageContainer = document.getElementById('imageContainer');
            const cropToggle = document.getElementById('cropToggle');
            const processImage = document.getElementById('processImage');
            const expressionResult = document.getElementById('expressionResult');
            const solutionResult = document.getElementById('solutionResult');
            const loadingSpinner = document.getElementById('loadingSpinner');
            const errorMessage = document.getElementById('errorMessage');

            // State Variables
            let cropper = null;
            let originalImage = null;
            let processedImage = null;

            // Reset UI State
            function resetUI() {
                if (cropper) {
                    cropper.destroy();
                    cropper = null;
                }
                cropToggle.classList.add('hidden');
                processImage.classList.add('hidden');
                expressionResult.value = '';
                solutionResult.value = '';
                errorMessage.textContent = '';
                errorMessage.classList.add('hidden');
                loadingSpinner.classList.add('hidden');
            }

            // Resize Image to 640px
            function resizeImage(img) {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const maxSize = 640;
                let width = img.width;
                let height = img.height;

                if (width > height) {
                    if (width > maxSize) {
                        height *= maxSize / width;
                        width = maxSize;
                    }
                } else {
                    if (height > maxSize) {
                        width *= maxSize / height;
                        height = maxSize;
                    }
                }

                canvas.width = width;
                canvas.height = height;
                ctx.drawImage(img, 0, 0, width, height);
                return canvas.toDataURL();
            }

            // Image Upload Event Listener
            imageUpload.addEventListener('change', (e) => {
                // Reset previous state
                resetUI();

                const file = e.target.files[0];
                const reader = new FileReader();

                reader.onload = (event) => {
                    const img = new Image();
                    img.onload = () => {
                        // Resize and display image
                        const resizedImageDataUrl = resizeImage(img);
                        uploadedImage.src = resizedImageDataUrl;
                        imageContainer.style.display = 'block';
                        
                        // Show control buttons
                        cropToggle.classList.remove('hidden');
                        processImage.classList.remove('hidden');
                        
                        // Store original resized image
                        originalImage = resizedImageDataUrl;
                    };
                    img.src = event.target.result;
                };

                reader.readAsDataURL(file);
            });

            // Crop Toggle Event Listener
            cropToggle.addEventListener('click', () => {
                if (cropper) {
                    cropper.destroy();
                    cropper = null;
                    cropToggle.textContent = 'Select Crop Area';
                    processImage.disabled = false;
                } else {
                    cropper = new Cropper(uploadedImage, {
                        aspectRatio: NaN,
                        viewMode: 1,
                    });
                    cropToggle.textContent = 'Cancel Crop';
                    processImage.disabled = true;
                }
            });

            // Process Image Event Listener
            processImage.addEventListener('click', async () => {
                // Reset previous results and show loading
                expressionResult.value = '';
                solutionResult.value = '';
                errorMessage.classList.add('hidden');
                loadingSpinner.classList.remove('hidden');

                try {
                    // Determine which image to process
                    let imageToProcess = originalImage;

                    // If cropper is active, use cropped image
                    if (cropper) {
                        imageToProcess = cropper.getCroppedCanvas().toDataURL();
                    }

                    // Remove data URL prefix for API
                    const base64Image = imageToProcess.split(',')[1];

                    // API Call to HuggingFace Space
                    const response = await fetch('https://oppastech-handwriting-math-ocr.hf.space/run/predict', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            data: [base64Image]
                        })
                    });

                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }

                    const responseData = await response.json();

                    // Process the response
                    if (responseData.data && responseData.data.length > 0) {
                        const [expression, solution] = responseData.data;
                        expressionResult.value = expression || 'No expression detected';
                        solutionResult.value = solution || 'No solution available';
                    } else {
                        throw new Error('No data received from the API');
                    }
                } catch (error) {
                    console.error('Error processing image:', error);
                    errorMessage.textContent = `Error: ${error.message}. Please try again.`;
                    errorMessage.classList.remove('hidden');
                    expressionResult.value = '';
                    solutionResult.value = '';
                } finally {
                    // Always hide loading spinner
                    loadingSpinner.classList.add('hidden');
                }
            });
        });
    </script>
</body>
</html>
